#!groovy

/**
 *  Jenkinsfile: catalogador-tfg - Pipeline produccion
 *  @hugo-lorenzo-mato
 */

def appName = 'catalogador-tfg'
def nodeImage = 'node:6'
def gradleImage = 'frekele/gradle:4.2.1-jdk8'
def gradleImage2 = 'gradle:latest'
def mavenChromeImage = 'markhobson/maven-chrome:latest'
def flywayImage = 'boxfuse/flyway:5'

def db = null
def dbHostname = null
def dbName = 'postgres'
def dbUser = 'postgres'
def dbPassword = 'postgres'

def web = null
def webHostname = null

node() {
    try {
        stage('Git: Checkout') {
            echo 'Checking out git repository'
            sh "git config --global credential.helper 'cache --timeout=3600'"
        checkout scm
        }
        
        docker.image(nodeImage).inside("-u 0:0") {
            stage('Node: Instalando dependencias') {
                sh "cd appserver/application && npm -v && node -v && npm install"
            }
            stage('Node: Empaquetado web') {
                sh "cd appserver/application && npm run build"
            }
        }

        docker.image(gradleImage).inside("-u 0:0") {
            stage('Gradle: Compilando') {
                sh "cd appserver/application && gradle -v && gradle war"
            }
            stage ('Gradle: Pruebas Base (unidad - integracion)') {
                sh "cd appserver/application && gradle test"
            }       

        }


        docker.image(gradleImage2).inside(){
            stage ('Control de Calidad de Código') {
                withSonarQubeEnv(sonarqubeName) {
                    sh "cd appserver/application && gradle -Dsonar.java.binaries=target/classes --debug sonarqube"
                }
            }
        }
        

    } finally {
        sh "echo 'Fallo en la ejecución del hilo ejecutándolo como: '"
        sh "whoami"
    }

}
